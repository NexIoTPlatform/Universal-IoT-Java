"use strict";importScripts("liblcplay.js"),addEventListener("message",receiveMessage,!1);let loadSuccess=!1,m_nPlayId=0,port=0,playback=!1,canvasWidth=0,canvasHeight=0,jsInputData=null,jsInputDataAry=null,jsInputStream=null,jsInputStreamAry=null,jsFrameInfo=null,m_iVideoFrameTimestamp=0,jsFrameBuf=null,dataView=null,videoEncodeType=0,smartEncode=0,supportH264MSE=!0,supportH265MSE=!0,preWidth=0,preHeight=0,jsBuf=null,jsBufY=null,jsBufU=null,jsBufV=null,jsFrameBodyData=null,jsYuvDataY=null,jsYuvDataU=null,jsYuvDataV=null,jsPreAudioDataLenth=0,jsI16AudioData=null,jsF32AudioData=null,jsAudioBuf=null,jsAudioData=null,frameRate=15,lastTime=0,msgDataToWorker=[],intervalId=null,playVideo=!1,dlNextTime=0,playspeed=1,pauseStatus=0,LOG_DOWMLOAD_ENALBE=!1,log_c=!1,log_js=!1,log_counter_last_clear_time=0,log_js_counter={},log_cpp_counter={};const LOGLEVEL_LOG=1,LOGLEVEL_INFO=2,LOGLEVEL_WARN=3,LOGLEVEL_ERROR=4;let streamBuf=null,streamBodyData=null,nextplayTime=0;const CACHE_MODE_OFF=0,ADAPTIVE_CACHE=1,REALTIME_FIRST=2,FLUENCY_FIRST=3,ENCODE_VIDEO_HI_H264=2,ENCODE_VIDEO_DH_H264=4,ENCODE_VIDEO_STD_H264=8,ENCODE_VIDEO_DH_H265=12,VIDEO_SMART_I=18,VIDEO_SMART_P=19,VIDEO_SMART_I_NORENDER=20,FRAME_TYPE_VIDEO=1,FRAME_TYPE_AUDIO=2,VIDEO_FRAME_SUB_TYPE_I=0,VIDEO_FRAME_SUB_TYPE_P=1,VIDEO_FRAME_SUB_TYPE_B=2;function getTimestamp(){return`[${(new Date).toISOString()}]`}function formatUTCDate(e){return`[${new Date(e).toISOString()}]`}function loggerArgsToString(...e){let t=e.map((e=>{if("object"===typeof e)try{return e instanceof Error?`Error: ${e.message}\n${e.stack}`:JSON.stringify(e,((e,t)=>t instanceof Error?`Error: ${t.message}`:t))}catch(e){return"[Unserializable Object]"}return String(e)})).join(" ");return t.length>1e3&&(t=t.slice(0,1e3),t+="(\u957f\u5ea6\u8d85\u8fc71000\u7701\u7565)"),t}function loggerLog(...e){if(log_js||LOG_DOWMLOAD_ENALBE){let t=getTimestamp()+`|PlaySdkWorker.js|${m_nPlayId}|`+loggerArgsToString(e);sendMessage(port,"PrintLogCallBack",{logLevel:1,logContent:t})}}function loggerWarn(...e){if(log_js||LOG_DOWMLOAD_ENALBE){let t=getTimestamp()+`|PlaySdkWorker.js|${m_nPlayId}|`+loggerArgsToString(e);sendMessage(port,"PrintLogCallBack",{logLevel:3,logContent:t})}}function loggerClearCounter(){}function loggerKeyLimit(e,t,...a){loggerWithKeyLimit(1,e,t,...a)}function loggerWithKeyLimit(e,t,a,...r){if(log_js||LOG_DOWMLOAD_ENALBE){const a=getTimestamp();t=`|PlaySdkWorker.js|${m_nPlayId}|`+t;const n=Date.now();loggerClearCounter(),log_js_counter[t]||(log_js_counter[t]={count:0,lastTimestamp:0});const o=log_js_counter[t];if(o.count+=1,n-o.lastTimestamp>=1e4){o.lastTimestamp=n;const l={logKey:t,logLevel:e,logContent:a+"!"+o.count+"~"+t+"!"+loggerArgsToString(r)};o.count=0,sendMessage(port,"PrintLogCallBack",l)}}}function loggerCppLimit(e,t,a){if(log_c){const r=getTimestamp();e=`|PlaySdkWorker.js|${m_nPlayId}|`+e,loggerClearCounter(),log_cpp_counter[e]||(log_cpp_counter[e]={count:0});const n=log_cpp_counter[e];if(n.count+=1,n.count<=t){sendMessage(port,"PrintLogCallBack",{logKey:e,logLevel:1,logContent:a})}if(n.count===t+1){sendMessage(port,"PrintLogCallBack",{logKey:e,logLevel:3,logContent:`${r}[\u65e5\u5fd7\u9650\u5236]\u5ffd\u7565Key"${e}"\u56e0\u4e3a\u8d85\u8fc7\u6bcf\u5206\u949f${t}\u6761`})}}}function receiveMessage(e){if(!loadSuccess)return;let t=e.data;switch(t.type){case"Init":m_nPlayId=t.option.nPlayId,playback=t.option.playback,canvasWidth=t.option.canvasWidth,canvasHeight=t.option.canvasHeight,supportH265MSE=t.option.supportH265MSE,supportH264MSE=t.option.supportH264MSE,log_c=t.option.log_c,log_js=t.option.log_js,LOG_DOWMLOAD_ENALBE=t.option.LOG_DOWMLOAD_ENALBE,loggerLog("receiveMessage type Init",m_nPlayId,port),init();break;case"InputData":inputData(t.data);break;case"Pause":loggerLog("receiveMessage type",t.type,m_nPlayId,port),pauseStatus=t.pause,pause(t.pause);break;case"Stop":loggerLog("receiveMessage type",t.type,m_nPlayId,port);let e=stop();postMessage(e);break;case"SetPlaySpeed":loggerLog("receiveMessage type",t.type,m_nPlayId,port),setPlaySpeed(t.speed);break;case"StartRecord":loggerLog("receiveMessage type",t.type,m_nPlayId,port),startRecord(t.port,t.recordType,t.nFileSize,t.strRecordName);break;case"StopRecord":loggerLog("receiveMessage type",t.type,m_nPlayId,port),stopRecord(t.port);break;case"SetSupportWebMSE":loggerLog("receiveMessage type",t.type,m_nPlayId,port),supportH265MSE=t.option.supportH265MSE,supportH264MSE=t.option.supportH264MSE,SetSupportWebMSE(supportH264MSE,supportH265MSE);break;case"SetSecurityKey":loggerLog("receiveMessage type",t.type,m_nPlayId,port),SetSecurityKey(t.szKey,t.keyLen);break;case"SetSecurityEncrytTypeKey":loggerLog("receiveMessage type",t.type,m_nPlayId,port),SetSecurityKeyByEncrytType(3,t.szKey,t.keyLen,null,0);break;default:loggerKeyLimit("receiveMessage \u672a\u77e5\u7c7b\u578b type=",5,t.type,m_nPlayId,port)}}function SetSecurityKey(e,t){let a=Module._malloc(e.length+1);Module.HEAPU8.set(e,a),Module.HEAPU8[a+e.length]=0,loggerLog("SetSecurityKey() call Module._PLAY_StreamEncryptKey() - \u5355\u7ebf\u7a0b"),Module._PLAY_StreamEncryptKey(a,t),Module._free(a)}function SetSecurityKeyByEncrytType(e,t,a,r,n){loggerLog("SetSecurityKeyByEncrytType----");const o=Module._malloc(49),l=new Uint8Array(Module.HEAPU8.buffer);let s=0;if(1==e)t.forEach(((e,t)=>{l[o+s|0]=e,s++}));else if(2==e){let e=new Uint8Array(16);if(l[o+s|0]=1,s++,0==n){for(let t=0;t>16;t++)e[t]=0;n=16,r=e}r.forEach(((e,t)=>{l[o+s|0]=e,s++})),t.forEach(((e,t)=>{l[o+s]=e,s++})),a=1+a+n,e=null}else 3==e&&t.split("").forEach(((e,t)=>{l[o+s|0]=e.charCodeAt(0),s++}));loggerLog("SetSecurityKeyByEncrytType() call Module._PLAY_SetSecurityKey() - \u5355\u7ebf\u7a0b"),Module._PLAY_SetSecurityKey(port,o,a),Module._free(o)}function SetSupportWebMSE(e,t){loggerLog("SetSupportWebMSE() ",m_nPlayId,port,e,t),Module._PLAY_SetSupportWebMSE(port,e,t)}function init(){let e=Module._malloc(1),t=new Uint8Array(Module.HEAPU8.buffer,e,1);Module._PLAY_GetFreePort(t.byteOffset),port=t[0],t=null,Module._free(e),Module._PLAY_Init(port,m_nPlayId);let a=Module._PLAY_SetStreamOpenMode(port,playback);if(a=Module._PLAY_OpenStream(port,0,0,10485760),a=Module._PLAY_SetCacheMode(port,1),a=Module._PLAY_PlaySound(port),a=Module._PLAY_SetPrintLogLevel(log_c?1:0),a=Module._PLAY_SetDecodeThreadNum(port,1),loggerLog(" init() SetSupportWebMSE ",m_nPlayId,port,supportH264MSE,supportH265MSE),a=Module._PLAY_SetSupportWebMSE(port,supportH264MSE,supportH265MSE),Module._PLAY_ViewResolutionChanged(port,canvasWidth,canvasHeight,0),Module._PLAY_ParseStreamInit(),a=Module._PLAY_Play(port,1),a){jsInputData=Module._malloc(5242880),jsInputDataAry=new Uint8Array(Module.HEAPU8.buffer,jsInputData,5242880),jsInputStream=Module._malloc(5242880),jsInputStreamAry=new Uint8Array(Module.HEAPU8.buffer,jsInputData,5242880),sendMessage(port,"InitSuccess",null)}}function pause(e){let t=Module._PLAY_Pause(port,e);loggerLog("_PLAY_Pause",m_nPlayId,port,t)}function startTimer(){clearInterval(intervalId),intervalId=setInterval((()=>{let e=!1,t=Date.now();0==nextplayTime&&(nextplayTime=t);let a=t-nextplayTime,r=msgDataToWorker.length;loggerKeyLimit("\u5faa\u73af\u6267\u884c",m_nPlayId,port,5,"diff:",a,"msgDataToWorker size:",r,"nextplayTime=",nextplayTime);let n=!0;for((1==videoEncodeType&&1==supportH264MSE||2==videoEncodeType&&1==supportH265MSE)&&!smartEncode&&(n=!pauseStatus);0<r&&r>0&&n&&a>=-5;){let t=msgDataToWorker[0];if("video"==t.type){if(1==e&&(1==videoEncodeType&&1==supportH264MSE||2==videoEncodeType&&1==supportH265MSE)&&!smartEncode)return;0===jsInputDataAry.byteLength&&(loggerKeyLimit("ArrayBuffer is detached",5),jsInputDataAry=null,jsInputDataAry=new Uint8Array(Module.HEAPU8.buffer,jsInputData,5242880)),jsInputDataAry.set(t.data),Module._PLAY_InputData(port,jsInputDataAry.byteOffset,t.datalen),msgDataToWorker.shift(),r=msgDataToWorker.length,e=!0,nextplayTime=(1==videoEncodeType&&1==supportH264MSE||2==videoEncodeType&&1==supportH265MSE)&&!smartEncode?Date.now()+1e3/frameRate/playspeed:Date.now(),loggerKeyLimit("frameRate:",5,frameRate,"playspeed:",playspeed)}else 0===jsInputDataAry.byteLength&&(loggerKeyLimit("ArrayBuffer is detached",5),jsInputDataAry=null,jsInputDataAry=new Uint8Array(Module.HEAPU8.buffer,jsInputData,5242880)),jsInputDataAry.set(t.data),Module._PLAY_InputData(port,jsInputDataAry.byteOffset,t.datalen),msgDataToWorker.shift(),r=msgDataToWorker.length}}),10)}function stop(){loggerLog("\u505c\u6b62",m_nPlayId,port);let e=1;return Module._PLAY_UnInit(port),Module._PLAY_ResetBuffer(port,1),Module._PLAY_ResetBuffer(port,2),Module._PLAY_ResetBuffer(port,3),Module._PLAY_ResetBuffer(port,4),e=Module._PLAY_Stop(port),0==e||(e=Module._PLAY_CloseStream(port),jsInputDataAry=null,Module._free(jsInputData),jsInputStreamAry=null,Module._free(jsInputStream),jsFrameBuf=null,jsFrameInfo=null,dataView=null,jsBufY=null,jsBufU=null,jsBufV=null,jsYuvDataY=null,jsYuvDataU=null,jsYuvDataV=null,jsAudioBuf=null,jsAudioData=null,preWidth=0,preHeight=0,Module._PLAY_ParseStreamUint(),intervalId&&(clearInterval(intervalId),intervalId=null),sendMessage(port,"stopFromWorker",{})),e}function setPlaySpeed(e){Module._PLAY_SetPlaySpeed(port,e),loggerLog("\u8bbe\u7f6e\u500d\u901f",m_nPlayId,port,e),playspeed!==e&&(playspeed=e)}function inputData(e){return null===intervalId&&startTimer(),0===jsInputStreamAry.byteLength&&(loggerKeyLimit("ArrayBuffer is detached",5),jsInputStreamAry=null,jsInputStreamAry=new Uint8Array(Module.HEAPU8.buffer,jsInputStream,5242880)),jsInputStreamAry&&(jsInputStreamAry.set(e),Module._PLAY_ParseStream(jsInputStreamAry.byteOffset,e.length)),0}function cPlusParseStreamCallBack(e,t,a,r,n){loggerKeyLimit("cPlusParseStreamCallBack C++\u8f6c\u7801\u56de\u8c03",5,e,t,a,r,n),streamBuf=new ArrayBuffer(n),streamBodyData=new Uint8Array(streamBuf),streamBodyData.set(Module.HEAPU8.subarray(r,r+n));let o=null,l=null;1==e?(loggerKeyLimit("frameid video:",5,a),o="video",l=0==t?"IFrame":"PFrame"):2==e?(loggerKeyLimit("frameid audio:",5,a),o="audio"):3==e&&(loggerKeyLimit("frameid data:",5,a),o="data"),msgDataToWorker.push({type:o,subtype:l,data:streamBodyData,datalen:n,frameId:a})}function cPlusVisibleDecCallBack(e,t,a,r,n,o,l){if(m_nPlayId!==e)return void loggerWithKeyLimit(3,"cPlusVisibleDecCallBack \u5ffd\u7565C++\u5e27\u4fe1\u606f\u56de\u8c03\uff0c\u56e0\u4e3aid\u4e0d\u540c",5,m_nPlayId,e,t,a,r,n,o,l);loggerWithKeyLimit(1,"cPlusVisibleDecCallBack C++\u5e27\u4fe1\u606f\u56de\u8c03",5,m_nPlayId,t,a,r,n,o,l);let s={};jsFrameInfo||(jsFrameBuf=new ArrayBuffer(40),jsFrameInfo=new Uint8Array(jsFrameBuf),dataView=new DataView(jsFrameBuf)),jsFrameInfo.set(Module.HEAPU8.subarray(l,l+40)),s.nFrameID=dataView.getUint32(0,!0),s.nFrameType=dataView.getUint8(4),s.nFrameSubType=dataView.getUint8(5),s.nYear=dataView.getUint16(30,!0),s.nMonth=dataView.getUint8(32),s.nDay=dataView.getUint8(33),s.nHour=dataView.getUint8(34),s.nMinute=dataView.getUint8(35),s.nSecond=dataView.getUint8(36);var u={};let i="VisibleDecCallBack";if(1==s.nFrameType){if(s.nEncodeType=dataView.getUint8(6),s.nStreamType=dataView.getUint8(7),2==s.nEncodeType||4==s.nEncodeType||8==s.nEncodeType?videoEncodeType=1:12==s.nEncodeType&&(videoEncodeType=2),s.nWidth=dataView.getUint16(16,!0),s.nHeight=dataView.getUint16(18,!0),0==s.nWidth||0==s.nHeight)return;if(s.nFrameRate=dataView.getUint8(37),s.nStride=dataView.getUint16(20,!0),frameRate=s.nFrameRate,18==s.nFrameSubType||19==s.nFrameSubType||20==s.nFrameSubType?smartEncode=1:0==s.nFrameSubType&&(smartEncode=0),(1==videoEncodeType&&1==supportH264MSE||2==videoEncodeType&&1==supportH265MSE)&&!smartEncode)i="VisibleMseDecCallBack",jsBuf=new ArrayBuffer(o),jsFrameBodyData=new Uint8Array(jsBuf),jsFrameBodyData.set(Module.HEAPU8.subarray(a,a+o)),u={pBufY:jsFrameBodyData,pBufU:null,pBufV:null,nSize:o,stuFrameInfo:s};else{s.nWidth==preWidth&&s.nHeight==preHeight||(preWidth=s.nWidth,preHeight=s.nHeight,jsBufY=null,jsBufU=null,jsBufV=null,jsYuvDataY=null,jsYuvDataU=null,jsYuvDataV=null,jsBufY=new ArrayBuffer(s.nWidth*s.nHeight),jsYuvDataY=new Uint8Array(jsBufY),jsBufU=new ArrayBuffer(s.nWidth*s.nHeight/4),jsYuvDataU=new Uint8Array(jsBufU),jsBufV=new ArrayBuffer(s.nWidth*s.nHeight/4),jsYuvDataV=new Uint8Array(jsBufV));let e=0;for(e=0;e<s.nHeight;e++)jsYuvDataY.set(Module.HEAPU8.subarray(a+e*s.nStride,a+e*s.nStride+s.nWidth),e*s.nWidth);for(e=0;e<s.nHeight/2;e++)jsYuvDataU.set(Module.HEAPU8.subarray(r+e*s.nStride/2,r+e*s.nStride/2+s.nWidth/2),e*s.nWidth/2);for(e=0;e<s.nHeight/2;e++)jsYuvDataV.set(Module.HEAPU8.subarray(n+e*s.nStride/2,n+e*s.nStride/2+s.nWidth/2),e*s.nWidth/2);u={pBufY:jsYuvDataY,pBufU:jsYuvDataU,pBufV:jsYuvDataV,nSize:o,stuFrameInfo:s}}let e=s.nYear,t=timeDeal(s.nMonth),l=timeDeal(s.nDay),p=timeDeal(s.nHour),d=timeDeal(s.nMinute),g=timeDeal(s.nSecond);s.timeStamp=Date.UTC(e,t,l,p,d,g)/1e3,s.utcTimeStamp=new Date(`${e}-${t}-${l} ${p}:${d}:${g}`).getTime();let y=m_iVideoFrameTimestamp,c=1e3*s.timeStamp,m=c-y;0!==m&&1e3!==m&&loggerWithKeyLimit(3,"\u89c6\u9891\u5e27\u65f6\u95f4\u53d8\u5316\u8d85\u8fc71\u79d2",50,formatUTCDate(y)+"->"+formatUTCDate(c)),m_iVideoFrameTimestamp=c}else if(2==s.nFrameType){i="VisibleDecCallBack",s.nSamples=dataView.getUint32(24,!0),s.nBits=dataView.getUint8(28,!0),s.nAudioChnNum=dataView.getUint8(29,!0),jsAudioBuf=new ArrayBuffer(o),jsAudioData=new Uint8Array(jsAudioBuf),jsAudioData.set(Module.HEAPU8.subarray(a,a+o)),jsI16AudioData=new Int16Array(jsAudioData.buffer,jsAudioData.byteOffset,jsAudioData.byteLength/Int16Array.BYTES_PER_ELEMENT),jsF32AudioData=new Float32Array(jsI16AudioData.length);for(let e=0;e<jsI16AudioData.length;e++)jsF32AudioData[e]=jsI16AudioData[e]/32768;u={pBufY:jsF32AudioData,pBufU:null,pBufV:jsYuvDataV,nSize:null,stuFrameInfo:s}}sendMessage(t,i,u),jsAudioBuf=null,jsAudioData=null,jsI16AudioData=null,jsF32AudioData=null}function timeDeal(e){return e<10?`0${e}`:e}function sendMessage(e,t,a){postMessage({nPlayId:m_nPlayId,port:e,type:t,data:a})}function startRecord(e,t,a,r){Module._PLAY_StartDataRecordEx(e,0,t)}function stopRecord(e){loggerLog("c++\u5c42\u5173\u95ed\u5f55\u5236",m_nPlayId,e),Module._PLAY_StopDataRecord(e),sendMessage(e,"closeRecord")}Module.onRuntimeInitialized=function(){loadSuccess=!0;sendMessage(port,"LoadSuccess",null)};let arrayRecord=null;function cPlusDataRecordCallBack(e,t,a,r){var n=new ArrayBuffer(a);arrayRecord=new Uint8Array(n),arrayRecord.set(Module.HEAPU8.subarray(t,t+a)),loggerKeyLimit("C++\u5f55\u5c4f\u6570\u636e\u56de\u8c03",5,m_nPlayId,port,"\u957f\u5ea6=",a,"\u504f\u79fb=",r),sendMessage(e,"recordStorageCallBack",{nPort:e,pRecordData:arrayRecord,nDataLen:a,nOffset:r})}function cPlusDigitalSignCallBack(e,t,a){loggerKeyLimit(a?"C++\u7801\u6d41\u89e3\u5bc6\u7ed3\u679c\u56de\u8c03 \u89e3\u5bc6\u6210\u529f":"C++\u7801\u6d41\u89e3\u5bc6\u7ed3\u679c\u56de\u8c03 \u89e3\u5bc6\u5931\u8d25",5,m_nPlayId,port),sendMessage(e,"cPlusDigitalSignCallBack",{nPort:e,nFrameID:t,bSuccess:a})}function cPlusStatisticCallBack(e,t,a,r){1003===t&&(loggerKeyLimit("statisticCallBack C++\u667a\u80fd\u5e27\u786c\u89e3\u5207\u8f6f\u89e3\u56de\u8c03",5,m_nPlayId,port,t,a,r),supportH265MSE=!1,supportH264MSE=!1,sendMessage(e,"switchToSW")),4===t?(loggerKeyLimit("statisticCallBack C++\u8f6f\u89e3\u89e3\u7801\u8017\u65f6\u56de\u8c03",5,m_nPlayId,port,t,a,r),sendMessage(e,"frameDecodeCost",{nPort:e,cost:a})):loggerKeyLimit("statisticCallBack \u672a\u4f7f\u7528\u7684C++\u6570\u636e\u56de\u8c03",5,m_nPlayId,port,t,a,r)}function cPlusLogMessageCallBack(e,t,a,r,n){let o=`[${UTF8ToString(e)}][${UTF8ToString(t)}:${a}][tid:${r}] ${UTF8ToString(n)}`;o.length>1e3&&(o=o.slice(0,1e3)+"(\u957f\u5ea6\u8d85\u8fc71000\u7701\u7565)"),loggerCppLimit("cpp_",1e3,o)}