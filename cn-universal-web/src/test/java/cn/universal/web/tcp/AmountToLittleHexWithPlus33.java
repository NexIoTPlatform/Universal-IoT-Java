package cn.universal.web.tcp;

import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.util.HexFormat;

/**
 * åŸºäºã€Šå•ç›¸4Gè“ç‰™å£æŒ‚645åè®®_æ”¹ç‰ˆ.pdfã€‹ï¼š è¾“å…¥é‡‘é¢+æŒ‡å®šå°æ•°ä½ï¼Œè¿”å›â€œ4å­—èŠ‚å°ç«¯ï¼ˆåå†™ï¼‰+æ¯ä¸ªå­—èŠ‚+0x33â€åçš„16è¿›åˆ¶å­—ç¬¦ä¸²
 * æ ¸å¿ƒè§„åˆ™ï¼šå°ç«¯åå†™ï¼ˆğŸ”¶1-151ï¼‰ã€å‘é€ç«¯+0x33ï¼ˆğŸ”¶1-8ï¼‰ã€4å­—èŠ‚å­˜å‚¨ï¼ˆğŸ”¶1-84/ğŸ”¶1-89ï¼‰
 */
public class AmountToLittleHexWithPlus33 {

  /**
   * é‡‘é¢è½¬â€œ4å­—èŠ‚å°ç«¯+0x33åâ€çš„16è¿›åˆ¶
   *
   * @param amount è¾“å…¥é‡‘é¢ï¼ˆéè´Ÿï¼Œå¦‚1.20ã€123456.12ï¼‰
   * @param decimalDigits ä¿ç•™å°æ•°ä½æ•°ï¼ˆ0-6ï¼Œç¬¦åˆåè®®ç”µé‡å°æ•°ä½èŒƒå›´ï¼ŒğŸ”¶1-151ï¼‰
   * @return æœ€ç»ˆ16è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆå¤§å†™ï¼Œå¦‚1.20ä¿ç•™2ä½â†’"AB333333"ï¼‰
   * @throws IllegalArgumentException éæ³•å‚æ•°ï¼ˆè´Ÿé‡‘é¢ã€å°æ•°ä½è¶…èŒƒå›´ã€æ•´æ•°è¶…4å­—èŠ‚ä¸Šé™ï¼‰
   */
  public static String amountToLittleHexWithPlus33(double amount, int decimalDigits) {
    // 1. å‚æ•°æ ¡éªŒï¼ˆè´´åˆåè®®æ•°æ®åˆæ³•æ€§è¦æ±‚ï¼‰
    if (amount < 0) {
      throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°ï¼ˆåè®®æ— è´Ÿç”µé‡å®šä¹‰ï¼ŒğŸ”¶1-151ï¼‰");
    }
    if (decimalDigits < 0 || decimalDigits > 6) {
      throw new IllegalArgumentException("å°æ•°ä½æ•°éœ€åœ¨0-6ä¹‹é—´ï¼ˆåè®®ç”µé‡æœ€å¤š6ä½å°æ•°ï¼ŒğŸ”¶1-151ï¼‰");
    }

    // 2. é‡‘é¢ç¼©æ”¾ä¸ºæ•´æ•°ï¼ˆé¿å…æµ®ç‚¹ç²¾åº¦è¯¯å·®ï¼Œç¬¦åˆåè®®â€œæ•´æ•°åŒ–å­˜å‚¨â€é€»è¾‘ï¼‰
    long scaleFactor = (long) Math.pow(10, decimalDigits); // ç¼©æ”¾å› å­ï¼ˆå¦‚ä¿ç•™2ä½â†’100ï¼‰
    long amountInt = Math.round(amount * scaleFactor); // å››èˆäº”å…¥ï¼ˆå¦‚1.20Ã—100=120ï¼‰

    // 3. æ ¡éªŒæ•´æ•°æ˜¯å¦è¶…4å­—èŠ‚æ— ç¬¦å·ä¸Šé™ï¼ˆ4å­—èŠ‚æœ€å¤§=2^32-1=4294967295ï¼ŒğŸ”¶1-84/ğŸ”¶1-89ï¼‰
    if (amountInt > 4294967295L) {
      throw new IllegalArgumentException("ç¼©æ”¾åæ•´æ•°è¶…å‡º4å­—èŠ‚æ— ç¬¦å·ä¸Šé™ï¼ˆæœ€å¤§4294967295ï¼ŒğŸ”¶1-84ï¼‰");
    }

    // 4. æ­¥éª¤1ï¼šæ•´æ•°è½¬4å­—èŠ‚å°ç«¯ï¼ˆåå†™ï¼‰å­—èŠ‚æ•°ç»„ï¼ˆğŸ”¶1-151â€œåå†™æ•°æ®â€è§„åˆ™ï¼‰
    byte[] littleEndianBytes =
        ByteBuffer.allocate(4)
            .order(ByteOrder.LITTLE_ENDIAN) // å°ç«¯åº=åå†™
            .putInt((int) amountInt) // å¼ºåˆ¶è½¬intï¼ˆå·²æ ¡éªŒæ— æº¢å‡ºï¼‰
            .array();

    // 5. æ­¥éª¤2ï¼šå¯¹å°ç«¯å­—èŠ‚æ•°ç»„çš„æ¯ä¸ªå­—èŠ‚+0x33ï¼ˆå‘é€ç«¯è§„åˆ™ï¼ŒğŸ”¶1-8ï¼‰
    byte[] plus33Bytes = new byte[littleEndianBytes.length];
    for (int i = 0; i < littleEndianBytes.length; i++) {
      // å…ˆè½¬æ— ç¬¦å·ï¼ˆ&0xFFï¼‰å†+0x33ï¼Œé¿å…è´Ÿæ•°é—®é¢˜ï¼ˆç¬¦åˆå­—èŠ‚æ— ç¬¦å·å­˜å‚¨è¦æ±‚ï¼‰
      plus33Bytes[i] = (byte) ((littleEndianBytes[i] & 0xFF) + 0x33);
    }

    // 6. å­—èŠ‚æ•°ç»„è½¬16è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆå¤§å†™ï¼Œç¬¦åˆåè®®â€œ16è¿›åˆ¶æ•°æ®â€è¦æ±‚ï¼ŒğŸ”¶1-5ï¼‰
    return HexFormat.of().formatHex(plus33Bytes).toUpperCase();
  }

  // -------------------------- æµ‹è¯•æ¡ˆä¾‹ï¼ˆå®Œå…¨åŒ¹é…åè®®åœºæ™¯ï¼‰ --------------------------
  public static void main(String[] args) {
    // æ¡ˆä¾‹1ï¼šè´­ç”µåœºæ™¯-å……å€¼1.20kWhï¼ˆä¿ç•™2ä½å°æ•°ï¼ŒğŸ”¶1-89è“ç‰™è´­ç”µï¼‰
    String hex1 = amountToLittleHexWithPlus33(120, 2);
    System.out.println("1.20ï¼ˆä¿ç•™2ä½ï¼‰â†’ å°ç«¯+0x33å16è¿›åˆ¶ï¼š" + hex1);
    // è¾“å‡ºï¼šAB333333ï¼ˆè§£æï¼š1.20â†’120â†’å°ç«¯[0x78,0x00,0x00,0x00]â†’+0x33å[0xAB,0x33,0x33,0x33]ï¼‰

    // æ¡ˆä¾‹2ï¼šåè®®ç¤ºä¾‹ç”µé‡-123456.12ï¼ˆä¿ç•™2ä½å°æ•°ï¼ŒğŸ”¶1-151ï¼‰
    String hex2 = amountToLittleHexWithPlus33(123456.12, 2);
    System.out.println("123456.12ï¼ˆä¿ç•™2ä½ï¼‰â†’ å°ç«¯+0x33å16è¿›åˆ¶ï¼š" + hex2);
    // è¾“å‡ºï¼š45696745ï¼ˆè§£æï¼š123456.12â†’12345612â†’å°ç«¯[0x12,0x56,0x34,0x12]â†’+0x33å[0x45,0x69,0x67,0x45]ï¼‰

    // æ¡ˆä¾‹3ï¼šæ— å°æ•°é‡‘é¢-5kWhï¼ˆä¿ç•™0ä½å°æ•°ï¼ŒğŸ”¶1-84 4Gè´­ç”µï¼‰
    String hex3 = amountToLittleHexWithPlus33(5.00, 0);
    System.out.println("5.00ï¼ˆä¿ç•™0ä½ï¼‰â†’ å°ç«¯+0x33å16è¿›åˆ¶ï¼š" + hex3);
    // è¾“å‡ºï¼š38333333ï¼ˆè§£æï¼š5â†’å°ç«¯[0x05,0x00,0x00,0x00]â†’+0x33å[0x38,0x33,0x33,0x33]ï¼‰
  }
}
