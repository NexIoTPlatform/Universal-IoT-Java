<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.universal.databridge.mapper.DataInputLogMapper">

  <!-- 查询最近的日志 -->
  <select id="selectRecentLogs" resultType="cn.universal.databridge.entity.DataInputLog">
    SELECT *
    FROM iot_data_input_log
    WHERE config_id = #{configId}
    ORDER BY create_time DESC
      LIMIT #{limit}
  </select>

  <!-- 计算成功率 -->
  <select id="calculateSuccessRate" resultType="java.lang.Double">
    SELECT
    CASE
    WHEN SUM(message_count) = 0 THEN 0.0
    ELSE ROUND(SUM(success_count) * 100.0 / SUM(message_count), 2)
    END as success_rate
    FROM iot_data_input_log
    WHERE config_id = #{configId}
    <if test="startTime != null">
      AND create_time >= #{startTime}
    </if>
    <if test="endTime != null">
      AND create_time &lt;= #{endTime}
    </if>
  </select>

  <!-- 删除过期日志 -->
  <delete id="deleteExpiredLogs">
    DELETE
    FROM iot_data_input_log
    WHERE create_time &lt; #{expireTime}
  </delete>

</mapper>
