# 配置结构优化说明

## 问题描述

原有的配置结构存在以下问题：

1. 动态配置被嵌套在 `extraConfig.dynamicConfig` 中，导致无法直接访问配置参数
2. 后端服务仍在使用旧的 `host`、`port`、`databaseName` 等独立字段进行验证
3. 前后端配置结构不一致，增加了数据处理的复杂度

**旧的配置结构**:

```json
{
  "name": "数据存入平台",
  "type": "MYSQL",
  "extraConfig": "{\"dynamicConfig\":{\"port\":3306,\"host\":\"192.168.31.194\",\"username\":\"root\"}}"
}
```

## 解决方案

### 1. 前端逻辑优化

**修改文件**: `ResourceForm.vue`

#### 1.1 提交时合并配置

```javascript
// 将动态配置直接合并到extraConfig中，不嵌套
const finalConfig = {
  ...extraConfigObj,  // 其他扩展配置
  ...this.form.dynamicConfig  // 动态配置直接展开
}
formData.extraConfig = JSON.stringify(finalConfig)
```

#### 1.2 编辑时解析配置

```javascript
// 支持两种格式的兼容
if (extraConfigObj.dynamicConfig) {
  // 旧格式：{dynamicConfig: {...}}
  this.form.dynamicConfig = extraConfigObj.dynamicConfig
} else {
  // 新格式：{host: ..., port: ..., ...}
  this.form.dynamicConfig = extraConfigObj
  this.form.extraConfig = ''
}
```

### 2. 后端服务优化

**修改文件**: `ResourceConnectionService.java`

#### 2.1 移除旧的字段验证

- 删除 `validateConnection()` 方法（不再验证 host、port、databaseName）
- 删除 `isHostPortExists()` 方法（不再检查主机端口重复）
- 使用 `ConfigValidator.validateResourceConnection()` 进行基本验证

#### 2.2 简化创建和更新逻辑

```java
// 创建资源连接
public Long createResourceConnection(ResourceConnection connection) {
    // 1. 验证连接（使用ConfigValidator进行基本验证）
    ConfigValidator.validateResourceConnection(connection);
    
    // 2. 检查重名
    if (isNameExists(connection.getName(), null)) {
        throw new RuntimeException("资源连接名称已存在");
    }
    
    // 3. 保存连接
    // ...
}
```

### 3. 配置验证优化

**修改文件**: `ConfigValidator.java`

#### 3.1 简化验证逻辑

```java
public static void validateResourceConnection(ResourceConnection connection) {
    // 验证名称
    validateName(connection.getName(), "资源连接名称");
    
    // 验证资源类型
    if (connection.getType() == null) {
        throw new DataBridgeException("INVALID_RESOURCE_TYPE", "资源类型不能为空");
    }
    
    // 验证数据流向
    if (connection.getDataDirection() == null) {
        throw new DataBridgeException("INVALID_DATA_DIRECTION", "数据流向不能为空");
    }
    
    // 验证扩展配置JSON格式
    if (connection.getExtraConfig() != null && !connection.getExtraConfig().trim().isEmpty()) {
        validateJsonFormat(connection.getExtraConfig(), "扩展配置");
    }
}
```

## 新的配置结构

### 数据存储格式

```json
{
  "name": "数据存入平台",
  "type": "MYSQL",
  "direction": "OUT",
  "dataDirection": "OUTPUT",
  "status": 1,
  "description": "MySQL数据库连接",
  "extraConfig": "{\"port\":3306,\"charset\":\"utf8mb4\",\"host\":\"192.168.31.194\",\"username\":\"root\",\"password\":\"Haha@2025\",\"databaseName\":\"unix_db\"}"
}
```

### 前端使用格式

```javascript
// form.dynamicConfig 包含所有连接配置
{
  port: 3306,
  charset: "utf8mb4",
  host: "192.168.31.194",
  username: "root",
  password: "Haha@2025",
  databaseName: "unix_db"
}
```

## 优势

1. **配置扁平化** - 所有配置参数都在同一层级，便于访问
2. **后端简化** - 不再依赖独立的 host、port 字段，减少数据冗余
3. **灵活性** - 可以轻松扩展任意类型的配置参数
4. **向后兼容** - 前端支持两种格式的解析，平滑迁移
5. **统一管理** - 所有配置参数都在 extraConfig 中统一管理

## 数据库表结构

```sql
CREATE TABLE `iot_resource_connection` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `name` varchar(100) NOT NULL COMMENT '资源名称（支持中文）',
  `type` varchar(20) NOT NULL COMMENT '资源类型(MYSQL,KAFKA,MQTT,HTTP)',
  `extra_config` text COMMENT '扩展配置JSON（包含所有动态配置）',
  `status` tinyint DEFAULT '1' COMMENT '状态(0:禁用,1:启用)',
  `description` varchar(500) DEFAULT NULL COMMENT '描述',
  `direction` varchar(10) NOT NULL DEFAULT 'OUT' COMMENT '方向：IN-输入，OUT-输出，BOTH-双向',
  `data_direction` varchar(20) DEFAULT 'OUTPUT' COMMENT '数据流向：INPUT-输入，OUTPUT-输出，BIDIRECTIONAL-双向',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `create_by` varchar(50) DEFAULT NULL COMMENT '创建者',
  `update_by` varchar(50) DEFAULT NULL COMMENT '更新者',
  PRIMARY KEY (`id`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_direction` (`direction`),
  KEY `idx_data_direction` (`data_direction`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资源连接表';
```

## 迁移说明

### 对于现有数据

1. 前端会自动识别旧格式（嵌套的 dynamicConfig）
2. 编辑并保存后会自动转换为新格式
3. 无需手动迁移数据

### 对于新数据

1. 直接使用新格式存储
2. 所有配置参数直接存储在 extraConfig 中

## 注意事项

1. **向后兼容** - 前端代码支持两种格式，确保平滑过渡
2. **配置访问** - 后端需要从 extraConfig JSON 中解析出需要的配置参数
3. **字段弃用** - host、port、databaseName 字段已弃用，但保留在表结构中以兼容旧数据

